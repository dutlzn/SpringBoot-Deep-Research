---
typora-root-url: /images
---

# 异常报告



* 异常报告类介绍
* SpringBoot异常处理流程
* 案例分析
* 总结

https://www.cnblogs.com/markLogZhu/p/12517698.html

作用：

收集错误信息，用于向用户报告错误原因

```java
/*
 * Copyright 2012-2019 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.springframework.boot;

import org.springframework.context.ApplicationContextAware;
import org.springframework.context.ConfigurableApplicationContext;
import org.springframework.core.io.support.SpringFactoriesLoader;

/**
 * Callback interface used to support custom reporting of {@link SpringApplication}
 * startup errors. {@link SpringBootExceptionReporter reporters} are loaded via the
 * {@link SpringFactoriesLoader} and must declare a public constructor with a single
 * {@link ConfigurableApplicationContext} parameter.
 *
 * @author Phillip Webb
 * @since 2.0.0
 * @see ApplicationContextAware
 */
@FunctionalInterface
public interface SpringBootExceptionReporter {

   /**
    * Report a startup failure to the user.
    * @param failure the source failure
    * @return {@code true} if the failure was reported or {@code false} if default
    * reporting should occur.
    */
   boolean reportException(Throwable failure);

}
```



## 源码解读

https://blog.csdn.net/u014401141/article/details/107379164



```java
public ConfigurableApplicationContext run(String... args) {
   StopWatch stopWatch = new StopWatch();
   stopWatch.start();
   ConfigurableApplicationContext context = null;
    // 这里
   Collection<SpringBootExceptionReporter> exceptionReporters = new ArrayList<>();
   configureHeadlessProperty();
   SpringApplicationRunListeners listeners = getRunListeners(args);
   listeners.starting();
   try {
      ApplicationArguments applicationArguments = new DefaultApplicationArguments(args);
      ConfigurableEnvironment environment = prepareEnvironment(listeners, applicationArguments);
      configureIgnoreBeanInfo(environment);
      Banner printedBanner = printBanner(environment);
      context = createApplicationContext();
       // 这里
      exceptionReporters = getSpringFactoriesInstances(SpringBootExceptionReporter.class,
            new Class[] { ConfigurableApplicationContext.class }, context);
      prepareContext(context, environment, listeners, applicationArguments, printedBanner);
      refreshContext(context);
      afterRefresh(context, applicationArguments);
      stopWatch.stop();
      if (this.logStartupInfo) {
         new StartupInfoLogger(this.mainApplicationClass).logStarted(getApplicationLog(), stopWatch);
      }
      listeners.started(context);
      callRunners(context, applicationArguments);
   }
   catch (Throwable ex) {
      handleRunFailure(context, ex, exceptionReporters, listeners);
      throw new IllegalStateException(ex);
   }

   try {
      listeners.running(context);
   }
   catch (Throwable ex) {
      handleRunFailure(context, ex, exceptionReporters, null);
      throw new IllegalStateException(ex);
   }
   return context;
}
```



spring.factories

```
# Error Reporters
org.springframework.boot.SpringBootExceptionReporter=\
org.springframework.boot.diagnostics.FailureAnalyzers
```

类

```
FailureAnalyzers
```



新建一个except包

```java
package com.example.sb2.except;

public class AException extends Exception {
    public AException(Throwable cause) {
        super(cause);
    }
}
```



```
try {
   throw new CException(new BException(new AException(new Exception("test"))));
} catch (Throwable t) {
   while ( t != null ){
      System.out.println(t.getClass());
      t = t.getCause();
   }
}
```



## 框架实现

* run方法
* Collection<SpringBootExceptionReporter> 
* getSpringFactoriesInstance
* 填充集合内容



## reportException实现

* analyze方法
* 遍历analyzer集合找到能处理该异常的对象
* report方法
* FailureAnalysisReporter实现类报告异常



## FailureAnalyzer介绍



![](/56.png)

## analyze逻辑

* getCauseType方法

* 获取子类感兴趣异常类型

* findCause方法

* 判断当前抛出的异常栈是否包含子类感兴趣异常

* 调用子类具体analyze实现给出异常分析结果类

  

## FailureAnalysisReporter介绍

* 功能： 报告异常给到用户
* 实现类： LoggingFailureAnalysisReporter
* 实现方法： 根据失败分析结果类构建错误信息输出



