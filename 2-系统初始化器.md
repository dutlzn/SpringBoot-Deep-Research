---
typora-root-url: /images	
---

# 系统初始化器

ctrl+n 查找

ctrl+alt+b 查找实现类

# 系统初始化器概览



* 类名：ApplicationContextInitializer

* 介绍：Spring容器刷新之前执行的一个回调函数

* 作用：向SpringBoot容器中注册属性

* 使用：继承接口自定义实现



# 系统初始化器实战



我们知道Spring 是一个扩展性很强的容器框架，为开发者提供了丰富的扩展入口，其中一个扩展点便是ApplicationContextInitializer （应用上下文初始化器 或者 系统初始化器）。

ApplicationContextInitializer 是 Spring 在执行 **ConfigurableApplicationContext.refresh()** 方法对应用上下文进行刷新之前调用的一个回调接口，用来完成对 Spring 应用上下文个性化的初始化工作，该接口定义在 org.springframework.context 包中，其内部仅包含一个 initialize() 方法

官方对其描述是 Spring容器刷新之前执行的一个回调函数，**它的作用是向 Springboot容器中注册属性**。

**使用的话，可以继承接口自定义实现**，我们先认识一下它能呈现给我们的效果。

# 方法一：

初始化一个springboot项目之后，我们创建initializer的包，里面定义了一个自定义系统初始化器。该类继承了ApplicationContextInitializer，参数类型是ConfigurableApplicationContext 。

ConfigurableApplicationContext 接口的作用就是在ApplicationContext的基础上增加了一系列配置应用上下文的功能。

下面通过系统初始化器向springboot容器中注入属性的方式，





创建一个包 initializer 第一个 系统 初始化器

```java
package com.example.sb2.initializer;

import org.springframework.context.ApplicationContextInitializer;
import org.springframework.context.ConfigurableApplicationContext;
import org.springframework.core.annotation.Order;
import org.springframework.core.env.ConfigurableEnvironment;
import org.springframework.core.env.MapPropertySource;

import java.util.*;


// 定义Spring IOC容器中Bean的执行顺序的优先级，而不是定义Bean的加载顺序
@Order(1)
public class FirstInitializer implements
        ApplicationContextInitializer<ConfigurableApplicationContext> {

    @Override
    public void initialize(ConfigurableApplicationContext applicationContext) {
        // 获得环境
        ConfigurableEnvironment environment = applicationContext.getEnvironment();
        Map<String,Object> map = new HashMap<>();
        map.put("key1", "value1");
        // map打包成一个属性
        MapPropertySource mapPropertySource = new MapPropertySource("firstInitializer", map);
        environment.getPropertySources().addLast(mapPropertySource);
        System.out.println("******** Run FirstInitializer ******** ");
    }
}

```

之后我们在resource目录下创建一个META-INF，里面创建一个文件spring.factories（配置文件），配置信息是系统初始化器的路径。

```
org.springframework.context.ApplicationContextInitializer=com.example.sb2.initializer.FirstInitializer
```





创建一个服务类

TestService

```
package com.example.sb2.service;

import org.springframework.beans.BeansException;
import org.springframework.context.ApplicationContext;
import org.springframework.context.ApplicationContextAware;
import org.springframework.stereotype.Component;

@Component
public class TestService implements ApplicationContextAware {

    private ApplicationContext applicationContext;

    @Override
    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
        this.applicationContext = applicationContext;
    }

    public String test(){
        // 返回上下文当中的环境变量中的属性
        return applicationContext.getEnvironment().getProperty("key1");
    }
}
```



创建控制器  调用service 方法

```
package com.example.sb2.controller;

import com.example.sb2.bean.Demo;
import com.example.sb2.service.DemoService;
import com.example.sb2.service.TestService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import java.util.Optional;

@Controller
@RequestMapping("/demo")
public class DemoController {
    private static final Logger LOG = LoggerFactory.getLogger(DemoController.class);
    @Autowired
    private DemoService demoService;
    @Autowired
    private TestService testService;

    @RequestMapping("/hello/{id}")
    @ResponseBody
    public String hello(@PathVariable(value = "id") int id) {
        LOG.info("hello");
        return Optional.ofNullable(demoService.getDemoById(id)).map(Demo::toString)
                .orElse("empty result");
    }


    @RequestMapping("/test")
    @ResponseBody
    public String test() {
        return testService.test();
    }

}
```

运行项目  可以看到控制台里已经有打印的信息了

然后访问

http://localhost:8080/demo/test

可以返回value1



# 方法二：



```
package com.example.sb2.initializer;

import org.springframework.context.ApplicationContextInitializer;
import org.springframework.context.ConfigurableApplicationContext;
import org.springframework.core.annotation.Order;
import org.springframework.core.env.ConfigurableEnvironment;
import org.springframework.core.env.MapPropertySource;

import java.util.HashMap;
import java.util.Map;


// 定义Spring IOC容器中Bean的执行顺序的优先级，而不是定义Bean的加载顺序
@Order(2)
public class SecondInitializer implements
        ApplicationContextInitializer<ConfigurableApplicationContext> {

    @Override
    public void initialize(ConfigurableApplicationContext applicationContext) {
        // 获得环境
        ConfigurableEnvironment environment = applicationContext.getEnvironment();
        Map<String,Object> map = new HashMap<>();
        map.put("key2", "value2");
        // map打包成一个属性
        MapPropertySource mapPropertySource = new MapPropertySource("secondInitializer", map);
        environment.getPropertySources().addLast(mapPropertySource);
        System.out.println("******** Run SecondInitializer ******** ");
    }
}
```



换一种启动方式

```
package com.example.sb2;

import com.example.sb2.initializer.SecondInitializer;
import org.mybatis.spring.annotation.MapperScan;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
@MapperScan("com.example.sb2.mapper")
public class Sb2Application {

	public static void main(String[] args) {
//		SpringApplication.run(Sb2Application.class, args);
		SpringApplication springApplication = new SpringApplication(Sb2Application.class);
		springApplication.addInitializers(new SecondInitializer());
		springApplication.run(args);
	}

}
```



要注意更改service 的方法



# 方法三：

```
package com.example.sb2.initializer;

import org.springframework.context.ApplicationContextInitializer;
import org.springframework.context.ConfigurableApplicationContext;
import org.springframework.core.annotation.Order;
import org.springframework.core.env.ConfigurableEnvironment;
import org.springframework.core.env.MapPropertySource;

import java.util.HashMap;
import java.util.Map;


// 定义Spring IOC容器中Bean的执行顺序的优先级，而不是定义Bean的加载顺序
@Order(3)
public class ThirdInitializer implements
        ApplicationContextInitializer<ConfigurableApplicationContext> {

    @Override
    public void initialize(ConfigurableApplicationContext applicationContext) {
        // 获得环境
        ConfigurableEnvironment environment = applicationContext.getEnvironment();
        Map<String,Object> map = new HashMap<>();
        map.put("key3", "value3");
        // map打包成一个属性
        MapPropertySource mapPropertySource = new MapPropertySource("thirdInitializer", map);
        environment.getPropertySources().addLast(mapPropertySource);
        System.out.println("******** Run ThirdInitializer ******** ");
    }
}
```





修改属性配置文件

```
server.port=8080
spring.datasource.username=root
spring.datasource.password=123456
spring.datasource.url=jdbc:mysql://192.168.56.101:3306/test
spring.datasource.driver-class-name=com.mysql.jdbc.Driver
mybatis.mapper-locations=classpath:mapper/*.xml
mybatis.type-aliases-package=com.example.sb2.bean
mybatis.configuration.map-underscore-to-camel-case=true

# 初始化器配置
context.initializer.classes=com.example.sb2.initializer.ThirdInitializer
```



